name: Build (executable + wheel) on Windows
on:
  push:
    branches:
      - master

permissions:
  contents: write  # Für Release-Assets

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Python (mit pip Cache)
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'
        cache-dependency-path: |
          requirements.txt
          pyproject.toml

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # pip install -r requirements.txt
        pip install .
        pip install pyinstaller build setuptools

    - name: Build Wheel
      run: |
        python -m build --wheel  # This will create a wheel in the dist/ directory

    - name: Build Executable
      run: |
        pyinstaller --onefile --name readtx --paths src src/read_transactions/__main__.py --collect-submodules read_transactions --icon assets/readtx.ico
        # The executable will be in the dist/ directory created by PyInstaller

    # --- Release-Teil: neuestes Release ermitteln, Assets löschen, neue hochladen ---

    - name: Get latest release info
      id: latest
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { owner, repo } = context.repo;
          try {
            const latest = await github.rest.repos.getLatestRelease({ owner, repo });
            core.setOutput('id', latest.data.id.toString());
            core.setOutput('tag', latest.data.tag_name);
            core.setOutput('assets', JSON.stringify(
              latest.data.assets.map(a => ({ id: a.id, name: a.name }))
            ));
          } catch (e) {
            // Kein Release vorhanden
            core.warning(`No latest release found: ${e.message}`);
            core.setOutput('id', '');
            core.setOutput('tag', '');
            core.setOutput('assets', '[]');
          }

    - name: Delete existing assets from latest release
      if: steps.latest.outputs.id != ''
      uses: actions/github-script@v7
      env:
        ASSETS_JSON: ${{ steps.latest.outputs.assets }}
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { owner, repo } = context.repo;
          const raw = process.env.ASSETS_JSON || '[]';
          /** @type {{id:number,name:string}[]} */
          const assets = JSON.parse(raw);

          if (!assets.length) {
            core.info('No assets to delete.');
            return;
          }

          // Optional: nur bestimmte Dateien löschen (z.B. .exe & .whl)
          const toDelete = assets.filter(a => /\.(exe|whl)$/i.test(a.name));

          for (const a of toDelete) {
            core.info(`Deleting asset ${a.name} (id ${a.id})`);
            try {
              await github.rest.repos.deleteReleaseAsset({ owner, repo, asset_id: a.id });
            } catch (e) {
              core.warning(`Failed to delete ${a.name}: ${e.message}`);
            }
          }
    - name: Upload new assets to latest release
      if: steps.latest.outputs.tag != ''
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.latest.outputs.tag }}   # << WICHTIG: echter Tag!
        files: |
          dist/*.exe
          dist/*.whl
          assets/Vorlagen.dat
        fail_on_unmatched_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}